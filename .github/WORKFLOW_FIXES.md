# GitHub Actions Workflow Fixes

This document tracks the fixes applied to the macOS build workflow.

## Migration to Yarn

**Date:** 2025-10-14

The project has been migrated from pnpm to Yarn for better compatibility and simpler workflow configuration.

**Changes:**
- Replaced `pnpm-workspace.yaml` with `workspaces` field in `package.json`
- Updated `.npmrc` to use yarn configuration
- Changed `MODULE.bazel` to use `yarn.lock` instead of `pnpm-lock.yaml`
- Updated GitHub Actions workflow to use yarn (no separate installation needed)
- Updated all documentation to reference yarn commands

**Benefits:**
- Yarn is included with Node.js (no separate installation step needed in CI)
- Simpler workspace configuration
- Better compatibility with Electron Forge
- No need for `pnpm exec` workarounds

---

## Issues Encountered and Fixed (Historical - Pre-Yarn Migration)

### Issue 1: pnpm Not Found ✅ FIXED

**Error:**
```
Error: Unable to locate executable file: pnpm. Please verify either the file path exists...
```

**Root Cause:**
The workflow was trying to use pnpm for Node.js caching before pnpm was actually installed.

**Solution:**
Reordered the steps to install pnpm before setting up Node.js:

```yaml
# Before (incorrect):
- name: Setup Node.js
  uses: actions/setup-node@v4
  with:
    cache: 'pnpm'  # ❌ pnpm not installed yet

- name: Install pnpm
  uses: pnpm/action-setup@v3

# After (correct):
- name: Install pnpm
  uses: pnpm/action-setup@v4
  with:
    version: 9  # ✅ Updated to match local version

- name: Setup Node.js
  uses: actions/setup-node@v4
  with:
    cache: 'pnpm'  # ✅ Now pnpm is available
```

**Additional improvements:**
- Updated `pnpm/action-setup` from v3 to v4
- Updated pnpm version from 8 to 9 (matches local environment: 9.14.4)

---

### Issue 2: Proto Files Not Generated ✅ FIXED

**Error:**
```
Could not resolve "./gazel_pb.js" from "proto/index.ts"
file: /Users/runner/work/gazel/gazel/proto/index.ts
```

**Root Cause:**
The protobuf TypeScript files are generated by Bazel, but the workflow wasn't running Bazel to generate them before building the Electron app.

**Solution:**
Added Bazel setup and proto generation steps:

```yaml
- name: Setup Bazel
  uses: bazel-contrib/setup-bazel@0.9.0
  with:
    # Bazelisk will automatically use the version specified in .bazelversion
    bazelisk-cache: true
    disk-cache: ${{ github.workflow }}
    repository-cache: true

- name: Generate Proto Files
  run: |
    echo "Generating protobuf files with Bazel..."
    bazel build //proto:index
    echo "✓ Proto files generated"
```

**Why this approach:**
- Uses the official `bazel-contrib/setup-bazel` action
- Automatically uses the Bazel version from `.bazelversion` (8.4.2)
- Enables caching for faster subsequent builds:
  - `bazelisk-cache`: Caches Bazel binary
  - `disk-cache`: Caches build outputs
  - `repository-cache`: Caches external dependencies
- Generates all required proto files before Electron Forge runs

---

### Issue 3: Electron Package Not Found ✅ FIXED

**Error:**
```
✖ Packaging application [FAILED: Cannot find the package "electron".
Perhaps you need to run install it in "/Users/runner/work/gazel/gazel"?]
```

**Root Cause:**
This is a pnpm workspace issue. The project uses pnpm workspaces with multiple packages (`proto`, `electron`, `client`, `server`), and electron is listed as a dependency in both:
- Root `package.json` (devDependencies: `electron@^38.1.2`)
- `electron/package.json` (dependencies: `electron@^38.2.1`)

With `.npmrc` configured for hoisting (`node-linker=hoisted`, `shamefully-hoist=true`), electron is installed in the root `node_modules`, but when running `pnpm package` (which calls `electron-forge package`), Electron Forge couldn't properly resolve the electron package in the workspace setup.

**Solution:**
Use `pnpm exec` to run electron-forge commands, which ensures proper module resolution in pnpm workspaces:

```yaml
# Before (incorrect):
- name: Build and Package App
  run: pnpm package  # Calls electron-forge package via npm script

# After (correct):
- name: Build and Package App
  run: pnpm exec electron-forge package  # Direct call with pnpm exec
```

**Why this works:**
- `pnpm exec` sets up the correct `NODE_PATH` and module resolution for the workspace
- It ensures electron-forge can find the electron package even in a hoisted workspace setup
- This is the recommended way to run binaries in pnpm workspaces

---

## Current Workflow Steps

The workflow now executes in this order:

1. **Checkout code** - Get the repository
2. **Install pnpm** - Install package manager (v9)
3. **Setup Node.js** - Install Node.js with pnpm cache
4. **Install dependencies** - Run `pnpm install --frozen-lockfile`
5. **Setup Bazel** - Install Bazel via bazel-contrib action
6. **Generate Proto Files** - Build proto files with Bazel
7. **Import Certificate** - Set up code signing certificate
8. **Setup API Key** - Configure Apple notarization
9. **Build and Package** - Create signed .app bundle
10. **Create Installer** - Create signed and notarized installer
11. **Verify Signature** - Confirm code signing worked
12. **Upload Artifacts** - Store build outputs
13. **Create Release** - For version tags only
14. **Cleanup** - Remove sensitive files

---

## Performance Optimizations

### Caching Strategy

The workflow uses multiple caching layers:

1. **pnpm cache** (via `actions/setup-node@v4`):
   - Caches `node_modules` dependencies
   - Speeds up `pnpm install`

2. **Bazelisk cache** (via `setup-bazel`):
   - Caches the Bazel binary itself
   - Avoids re-downloading Bazel

3. **Bazel disk cache** (via `setup-bazel`):
   - Caches build outputs
   - Speeds up proto generation and builds

4. **Bazel repository cache** (via `setup-bazel`):
   - Caches external dependencies
   - Speeds up Bazel's dependency resolution

### Expected Build Times

- **First build** (no cache): ~15-20 minutes
  - Dependency installation: 2-3 minutes
  - Proto generation: 2-3 minutes
  - Electron build: 3-5 minutes
  - Notarization: 5-10 minutes

- **Subsequent builds** (with cache): ~10-15 minutes
  - Dependency installation: 30 seconds (cached)
  - Proto generation: 30 seconds (cached)
  - Electron build: 2-3 minutes
  - Notarization: 5-10 minutes (cannot be cached)

---

## Testing the Fixes

### Local Testing

Before pushing, you can test the proto generation locally:

```bash
# Install Bazel (if not already installed)
brew install bazelisk

# Generate proto files
bazel build //proto:index

# Verify generated files exist
ls -la bazel-bin/proto/

# Build the app
pnpm package
```

### GitHub Actions Testing

1. **Push to main** to trigger a build:
   ```bash
   git add .github/workflows/build-macos.yml
   git commit -m "Fix workflow: add Bazel setup for proto generation"
   git push origin main
   ```

2. **Monitor the build**:
   - Go to Actions tab in GitHub
   - Click on the running workflow
   - Watch each step complete

3. **Verify success**:
   - All steps should show green checkmarks
   - "Generate Proto Files" should show "✓ Proto files generated"
   - "Build and Package App" should complete without errors
   - Artifacts should be uploaded

---

## Troubleshooting

### If proto generation fails

**Check Bazel setup:**
```bash
# In the workflow logs, verify:
- Setup Bazel step completed successfully
- Bazel version matches .bazelversion (8.4.2)
- Proto generation step shows no errors
```

**Common issues:**
- Missing dependencies in MODULE.bazel
- Proto file syntax errors
- Bazel cache corruption (clear with `bazel clean`)

### If build still fails after proto generation

**Check that proto files are accessible:**
```bash
# The workflow should show these files exist:
bazel-bin/proto/gazel_pb.js
bazel-bin/proto/logging_pb.js
bazel-bin/proto/_virtual_imports/build_proto/build_pb.js
```

**Verify Vite can resolve proto imports:**
- Check `electron/vite.*.config.ts` alias configurations
- Ensure proto paths point to `bazel-bin/proto/`

---

## Future Improvements

### Potential Optimizations

1. **Parallel builds:**
   - Could split proto generation and dependency installation
   - Would save ~1 minute

2. **Conditional proto generation:**
   - Only regenerate if proto files changed
   - Would save time on non-proto changes

3. **Build matrix:**
   - Add Windows and Linux builds
   - Parallel execution across platforms

4. **Artifact optimization:**
   - Compress artifacts before upload
   - Reduce storage costs

### Monitoring

Consider adding:
- Build time tracking
- Cache hit rate monitoring
- Notarization time tracking
- Artifact size tracking

---

## Version History

| Date | Version | Changes |
|------|---------|---------|
| 2025-10-14 | 1.2 | Added Bazel setup for proto generation |
| 2025-10-14 | 1.1 | Fixed pnpm installation order, updated to v9 |
| 2025-10-14 | 1.0 | Initial workflow creation |

---

## Related Documentation

- [Main Setup Guide](../GITHUB_ACTIONS_SIGNING.md)
- [Quick Setup](QUICK_SETUP.md)
- [Troubleshooting Guide](TROUBLESHOOTING.md)
- [Secrets Checklist](SECRETS_CHECKLIST.md)

---

**Status**: ✅ All known issues resolved
**Last Updated**: 2025-10-14
**Workflow Version**: 1.2

