# Gazel Application

This module provides the main application targets for running Gazel in development and production modes.

## Quick Start

### Development Mode

Start both the server and client in development mode with hot-reloading:

```bash
bazel run //app:dev
```

This will:
- Start the gRPC server on http://localhost:3002
- Start the Vite dev server on http://localhost:5173
- Automatically open your browser to the client
- Enable hot-reloading for both server and client code

### Production Mode

Build and run the production version:

```bash
bazel run //app:main
```

This will:
- Build the client for production
- Start the server serving the built client files
- Open your browser to http://localhost:3002

## Available Targets

### Development Targets

- `//app:dev` - Run both server and client in development mode with browser auto-open
- `//app:dev_no_browser` - Same as dev but without opening the browser (useful for Electron)
- `//app:server_dev` - Run only the server in development mode

### Production Targets

- `//app:main` - Run the production server with built client files
- `//app:prod_server` - Run only the production server
- `//app:prod_build` - Build all production assets

## Architecture

The application consists of:
- **Server** (`//server`) - gRPC server using Connect protocol
- **Client** (`//client`) - Svelte-based web UI with Vite
- **Proto** (`//proto`) - Protocol buffer definitions for API

## Development Workflow

1. **Start development mode:**
   ```bash
   bazel run //app:dev
   ```

2. **Make changes to server or client code** - changes will be automatically detected and hot-reloaded

3. **Stop the servers** - Press Ctrl+C to gracefully shut down both servers

## Installation

No manual installation needed! Bazel automatically manages all dependencies through the pnpm-lock.yaml file. Just run:

```bash
bazel run //app:dev
```

## Usage

### Using the HTTP Client

```typescript
import { createHttpClient } from '@gazel/connect';

const client = createHttpClient('http://localhost:3002');

// Get current workspace
const workspace = await client.getCurrentWorkspace();

// List targets
const targets = await client.listTargets('//...');

// Get module graph
const graph = await client.getModuleGraph();
```

### Using the High-Level API Client

```typescript
import { GazelApiClient } from '@gazel/connect/client';

const api = new GazelApiClient('http://localhost:3002');

// Workspace operations
const workspace = await api.getCurrentWorkspace();
await api.switchWorkspace('/path/to/workspace');
const info = await api.getWorkspaceInfo();

// Target operations
const targets = await api.listTargets();
const target = await api.getTarget('//app:main');
const results = await api.searchTargets('test');

// Query operations
const queryResult = await api.executeQuery('deps(//...)');

// Build operations
const buildResult = await api.buildTarget('//app:main');

// Module operations
const moduleGraph = await api.getModuleGraph();
```

### Using Bazel-Generated Types

```typescript
import type {
  WorkspaceInfo,
  BazelTarget,
  Module,
  ModuleDependency,
} from '@gazel/connect';

// These types are generated by Bazel from the proto files
// and provide full TypeScript type safety
```

## Architecture

```
app/src/
├── index.ts        # Main entry point, exports types and clients
├── http-client.ts  # HTTP client implementation
├── client.ts       # High-level API client wrapper
└── example.html    # Browser example demonstrating usage
```

## Bazel Integration

This module uses types generated by Bazel's `ts_proto_library` rule. The generated files are located in `bazel-bin/proto/` and include:

- `gazel_pb.js` / `gazel_pb.d.ts` - Protobuf message types
- `logging_pb.js` / `logging_pb.d.ts` - Logging-related types

To regenerate the types after modifying the proto files:

```bash
bazel build //proto:gazel_ts_proto
bazel build //proto:logging_ts_proto
```

## Connect Protocol Support

While this module currently uses HTTP for communication, it's designed to support the Connect protocol in the future. The Connect protocol provides:

- Type-safe RPC calls
- Streaming support
- Better error handling
- Binary and JSON encoding

To add full Connect support, you would need to:

1. Add Connect service generation to the Bazel build
2. Update the server to use Connect handlers
3. Switch the client from HTTP to Connect transport

## Example

Open `app/example.html` in a browser to see a working example of the client in action. Make sure the Gazel server is running on port 3002:

```bash
# Start the server
pnpm run dev:server

# Open the example in a browser
open app/example.html
```

## Development

```bash
# Install dependencies
pnpm install

# Build TypeScript
pnpm run build

# Watch for changes
pnpm run watch
```

## Notes

- The client automatically detects the environment and uses appropriate defaults
- All API calls return promises and support async/await
- Error handling is built into the high-level client
- The HTTP client provides a lower-level interface for custom implementations
